Pasted-we-need-to-give-players-and-parents-a-way-to-change-or-reset-their-password-we-also-need-to-give-th-1753558810239_1753558810239.txt
we need to give players and parents a way to change or reset their password. we also need to give the admin the ability to do that too for all parents, players and themselves. we will ultimately leverage the ability to create an account using email and password but also offer to authenticate via google and 1 or two other typical ways consumers authenticate into accounts.


ChatGPT said:
Below is a comprehensive spec for adding full password management and social login to all portals (Player/Parent and Admin). It covers UX flows, database changes, server APIs, and UI components.

1. Database Changes
users table (already exists)

Add columns:

password_hash VARCHAR NULLABLE

password_reset_token VARCHAR NULLABLE

password_reset_expires TIMESTAMP NULLABLE

auth_providers TEXT[] (default ['local']) – e.g. ['local','google','apple']

login_attempts table (optional, for rate‑limiting/brute‑force protection)

id, user_id, timestamp, successful BOOLEAN

2. Server‐Side APIs
All routes under /api/auth or /api/admin/users.

2.1 Local Email/Password
Sign‑Up (Local)
POST /api/auth/signup
Body: { email, password, firstName, lastName, role:['parent'|'player'], … }

Validate email uniqueness

Hash password with bcrypt/Argon2 → store password_hash

Generate user record + send “Verify your email” link

Login (Local)
POST /api/auth/login
Body: { email, password }

Verify password_hash → issue session/JWT

Request Password Reset
POST /api/auth/forgot-password
Body: { email }

Generate a secure random token (e.g. 32 bytes, base64url)

Set password_reset_token, password_reset_expires = now()+1h

Send email: link https://…/reset-password?token=<token>

Reset Password
POST /api/auth/reset-password
Body: { token, newPassword }

Find user by password_reset_token and expiry > now

Hash newPassword, clear reset fields, update password_hash

Return success + optional auto‑login

Change Password (Authenticated)
POST /api/auth/change-password
Body: { currentPassword, newPassword }

Verify currentPassword vs password_hash

Hash+save newPassword

2.2 Social / OAuth Providers
For Google, Facebook, Apple, etc.:

OAuth Callback
GET /api/auth/oauth/:provider/callback?code=…

Exchange code for profile email via provider’s SDK

If email already exists in users: add provider to auth_providers[]

Else create new users record with auth_providers = ['google']

Link/Unlink Providers (Authenticated)
POST /api/auth/oauth/link
Body: { provider, code }

After linking successful, append to auth_providers[]
POST /api/auth/oauth/unlink
Body: { provider }

Remove from auth_providers[] (must keep >=1)

3. Admin APIs (Manage Other Users)
All protected by requireAdmin && require2FA.

Force‑reset Password
POST /api/admin/users/:userId/reset-password
Body: { newPassword? }

If newPassword provided: hash and set it, clear reset token

Else: generate one‑time reset token + email to user

Enable/Disable Local Login
PATCH /api/admin/users/:userId
Body: { canLocalLogin: boolean }

If disabled, strip local from auth_providers[]

4. Email Templates
Verification Email: /verify-email?token=…

Forgot Password: /reset-password?token=…

Admin‑initiated Reset: “Your password was reset by an administrator. Your new password is: …” or link to self‑serve reset

5. Client‑Side UI
5.1 Public Portal (Parent/Player)
Sign‑Up Page

Tabs: Email / Google / Facebook

Email form: email, password, confirm

“Sign up with Google” button → redirect to /auth/oauth/google

Login Page

Fields: Email / Password

“Forgot password?” link → opens forgot‑password modal/page

Social login buttons

Forgot‑Password Page

Input: Email + Send reset link button

Confirmation message after submit

Reset‑Password Page

Reads token from query string

Inputs: New Password, Confirm

“Change password” button → POST /auth/reset-password

User Settings (Authenticated)

Change Password section: Current, New, Confirm + Update

Connected Accounts: list of auth_providers with Unlink / Link new provider

5.2 Admin Portal
Under Settings → User Management (or Users section):

User List

Columns: Name, Email, Role, Local Login (On/Off), OAuth Providers, Actions

Actions

Reset Password: opens modal to either auto‑generate or set a new one

Disable Local Login: toggle switch

Link Social (optional)

Field‑level Security

Show/hide password fields only to Admin+2FA

6. Security & Best Practices
Rate‑limit password‑reset and login attempts by IP/user.

Validate all passwords server‑side (min length, complexity).

Store only hashed passwords (bcrypt/Argon2).

Expire reset tokens (1 hour max).

Require 2FA for all admin‑level password operations.

7. Rollout Plan
Migrations → add columns + tables.

Auth APIs → build & test flows with Postman.

Email service → integrate SendGrid/SendGrid API key from Admin → Integrations.

Client UI → wire forms & modals, hook up to APIs.

Admin UI → add password‑reset actions, provider linking.

QA → test every flow (sign‑up, login, reset, change, social link/unlink).

Deploy & monitor for err...